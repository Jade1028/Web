<div class="slider">
    <div class ="list">
        <div class ="item">
            <img src="images/img1.png" alt="image" title="New book arrival">
        </div>
        <div class ="item">
            <img src="images/img2.png" alt="image" title="Discount">
        </div>
        <div class ="item">
            <img src="images/img3.png" alt="image" title="Back to school">
        </div>
   </div>


<!-- button for prev and next -->
    <div class="buttons">
        <button id="prev"><</button>
        <button id="next">></button>
    </div>

<!-- dots -->
    <ul class="dots">
        <li class="active"></li>
        <li></li>
        <li></li>
    </ul>
</div>

<!-- Books
<div class="container">

   <h3 class="title"> OUR PRODUCTS </h3>
   <h5> Historical Fiction</h5>
   <div class="same-types">
      <div class="products-container">
         <div class="product" data-name="hf-1">
            <img src="images/hf_1.png" alt="png">
            <h3></h3>
            <div class="price">RM 64.99</div>
         </div>

         <div class="product" data-name="hf-2">
            <img src="images/hf_2.png" alt="png">
            <h3>The Lion Women of Tehran</h3>
            <div class="price">RM 69.99</div>
         </div>

         <div class="product" data-name="hf-3">
            <img src="images/hf_3.png" alt="png">
            <h3>The Briar Club</h3>
            <div class="price">RM 49.99</div>
         </div>

         <div class="product" data-name="hf-4">
            <img src="images/hf_4.png" alt="png">
            <h3>Ne'er Duke Well</h3>
            <div class="price">RM 54.99</div>
         </div>

         <div class="product" data-name="hf-5">
            <img src="images/hf_5.png" alt="png">
            <h3>The Women</h3>
            <div class="price">RM 99.99</div>
         </div>

         <div class="product" data-name="hf-6">
            <img src="images/hf_6.png" alt="png">
            <h3>The King's Witches</h3>
            <div class="price">RM 79.99</div>
         </div>
         
      </div>
   </div>
</div>

<div class="container">
   <h5>Kids</h5>
   <div class="same-types">
      <div class="products-container">
         <div class="product" data-name="p-1">
            <img src="images/test.png" alt="png">
            <h3>Title of books</h3>
            <div class="price">RM 49.99</div>
         </div>

         <div class="product" data-name="p-2">
            <img src="images/test.png" alt="png">
            <h3>Title of books</h3>
            <div class="price">RM 49.99</div>
         </div>

         <div class="product" data-name="p-3">
            <img src="images/test.png" alt="png">
            <h3>Title of books</h3>
            <div class="price">RM 49.99</div>
         </div>
      </div>
   </div>
</div>


<div class="products-preview">

   <div class="preview" data-target="hf-1">
      <img src="images/hf_1.png" alt="png">
      <div class="close">X</div>
      <h3>The Bright Sword</h3>
      <h6>By Lev Grossman</h6>
      <p>A gifted young knight named Collum arrives at Camelot to compete for a spot on the Round Table, only to find he’s too late. The king died two weeks ago at the Battle of Camlann, leaving no heir, and only a handful of the knights of the Round Table survive.
        <br><br> 
         They aren’t the heroes of legend, like Lancelot or Gawain. They’re the oddballs of the Round Tables, from the edges of the stories, like Sir Palomides; the Saracen Knight; and Sir Dagonet, Arthur’s fool, who was knighted as a joke. They’re joined by Nimue, who was Merlin’s apprentice until she turned on him and buried him under a hill. Together this ragtag fellowship will set out to rebuild Camelot in a world that has lost its balance.
         <br><br>
         But Arthur’s death has revealed Britain’s fault lines. God has abandoned it, and the fairies and monsters and old gods are returning, led by Arthur’s half-sister Morgan le Fay. Kingdoms are turning on each other, warlords are laying siege to Camelot, and rival factions are forming around the disgraced Lancelot and the fallen Queen Guinevere. It is up to Collum and his companions to reclaim Excalibur, solve the mysteries of this ruined world and make it whole again. But before they can restore Camelot they’ll have to learn the truth of why the lonely, brilliant King Arthur fell and lay to rest the ghosts of his troubled family and of Britain’s dark past.</p>
      <div class="price">RM 64.99</div>
      <div class="cartButton">
         <a href="#" class="cart">add to cart</a>
      </div>
   </div>

   <div class="preview" data-target="hf-2">
      <img src="images/hf_2.png" alt="png">
      <div class="close">X</div>
      <h3>The Lion Women of Tehran</h3>
      <h6>By Marjan Kamali</h6>
      <p>In 1950s Tehran, seven-year-old Ellie lives in grand comfort until the untimely death of her father, forcing Ellie and her mother to move to a tiny home downtown. Lonely and bearing the brunt of her mother’s endless grievances, Ellie dreams of a friend to alleviate her isolation.
         <br><br>   
         Luckily, on the first day of school, she meets Homa, a kind, passionate girl with a brave and irrepressible spirit. Together, the two girls play games, learn to cook in the stone kitchen of Homa’s warm home, wander through the colorful stalls of the Grand Bazaar, and share their ambitions for becoming “lion women.”</p>
      <div class="price">RM 69.99</div>
      <div class="cartButton">
         <a href="#" class="cart">add to cart</a>
      </div>
   </div>

   <div class="preview" data-target="hf-3">
      <img src="images/hf_3.png" alt="png">
      <div class="close">X</div>
      <h3>The Briar Club</h3>
      <h6>By Kate Quinn</h6>
      <p>Washington, D.C., 1950. Everyone keeps to themselves at Briarwood House, a down-at-the-heels all-female boardinghouse in the heart of the nation’s capital, where secrets hide behind white picket fences. But when the lovely, mysterious widow Grace March moves into the attic, she draws her oddball collection of neighbors into unlikely friendship: poised English beauty Fliss whose facade of perfect wife and mother covers gaping inner wounds; police officer’s daughter Nora, who is entangled with a shadowy gangster; frustrated baseball star Bea, whose career has ended along with the women’s baseball league of WWII; and poisonous, gung-ho Arlene, who has thrown herself into McCarthy’s Red Scare.</p>
      <div class="price">RM 49.99</div>
      <div class="cartButton">
         <a href="#" class="cart">add to cart</a>
      </div>
   </div>

   <div class="preview" data-target="hf-4">
      <img src="images/hf_4.png" alt="png">
      <div class="close">X</div>
      <h3>Ne'er Duke Well</h3>
      <h6>By Alexandra Vasti</h6>
      <p>Peter Kent―newly inherited Duke of Stanhope and recently of New Orleans, Louisiana―must become respectable. Between his radical politics and the time he interrupted a minor royal wedding with a flock of sheep―not his fault!―he’s developed a scandalous reputation at odds with his goal of becoming guardian to his half siblings. For help, he turns to the cleverest and most managing woman of his acquaintance, Lady Selina Ravenscroft.
         <br><br>
         Selina is society’s most proper debutante, save one tiny secret: she runs an erotic circulating library for women. When Peter asks for her help, she suggests courtship and marriage to a lady of unimpeachable reputation. (Which is to say, definitely not herself.)
         <br><br>
         But matchmaking doesn’t go according to plan. Peter’s siblings run rampant on Bond Street. Selina ends up in the Serpentine. And worst of all, the scorching chemistry between Peter and Selina proves impossible to resist. For the disreputable duke and his unpredictable matchmaker, falling in love just might be the ultimate scandal.
      </p>
      <div class="price">RM 54.99</div>
      <div class="cartButton">
         <a href="#" class="cart">add to cart</a>
      </div>
   </div>

   <div class="preview" data-target="hf-5">
      <img src="images/hf_5.png" alt="png">
      <div class="close">X</div>
      <h3>The Women</h3>
      <h6>By Kristin Hannah</h6>
      <p>'Women can be heroes, too'. When twenty-year-old nursing student, Frances "Frankie" McGrath, hears these unexpected words, it is a revelation. Raised on California's idyllic Coronado Island and sheltered by her conservative parents, she has always prided herself on doing the right thing, being a good girl. But in 1965 the world is changing, and she suddenly imagines a different path for her life. When her brother ships out to serve in Vietnam, she impulsively joins the Army Nurses Corps and follows his path.</p>
      <div class="price">RM 99.99</div>
      <div class="cartButton">
         <a href="#" class="cart">add to cart</a>
      </div>
   </div>

   <div class="preview" data-target="hf-6">
      <img src="images/hf_6.png" alt="png">
      <div class="close">X</div>
      <h3>The King's Witches</h3>
      <h6>By Kate Foster</h6>
      <p>1589. Princess Anna of Denmark is betrothed to King James VI of Scotland. Before they can wed, Anna must pass the trial period: one year of marriage to prove herself worthy of being Scotland's new Queen. Determined to fulfil her duties to King and country, Anna resolves to be the perfect royal bride. Until she meets Lord Henry . . .
         <br><br>
         By her side is Kirsten Sorenson, her loyal and pious lady-in-waiting. But, whilst tending to Anna's every need, Kirsten has her own secret motives for the royal marriage to succeed . . .
         <br><br>
         Meanwhile, in North Berwick, young housemaid Jura practises the healing charms taught to her by her mother. When she realizes she is no longer safe, she escapes to Edinburgh, only to find herself caught up in the witchcraft mania that has gripped not just the capital, but the new queen . . .</p>
      <div class="price">RM 79.99</div>
      <div class="cartButton">
         <a href="#" class="cart">add to cart</a>
      </div>
   </div>
</div>
-->
<?php
if (session_status() === PHP_SESSION_NONE) {
   session_start();
}

   // Database connection
   $conn = mysqli_connect('localhost', 'root', '', 'GoBookDB');

   if (!$conn) {
       die("Connection failed: " . mysqli_connect_error());
   }

   $sql = "CREATE TABLE IF NOT EXISTS Product (
      id INT AUTO_INCREMENT PRIMARY KEY,
      book_image VARCHAR(255) NOT NULL,
      book_name VARCHAR(255) NOT NULL,
      author VARCHAR(255) NOT NULL,
      price INT NOT NULL,
      description TEXT NOT NULL,
      category VARCHAR(255) NOT NULL
  )";

  if ($conn->query($sql) === FALSE) 
  {
      echo "Error creating table: " . $conn->error;
  }

   $sql = "CREATE TABLE IF NOT EXISTS cart (
      id INT AUTO_INCREMENT PRIMARY KEY,
      email VARCHAR(255) NOT NULL,
      book_image VARCHAR(255) NOT NULL,
      book_name VARCHAR(255) NOT NULL,
      price INT NOT NULL,
      quantity INT NOT NULL
   )"; 

   if ($conn->query($sql) === FALSE) 
   {
      echo "Error creating table: " . $conn->error;
   } 

   function getFileContents($filePath) {
      if (file_exists($filePath)) {
          return file_get_contents($filePath);
      } else {
          return '';
      }
  }
  
  $products = [
      [
          'image' => 'images/hf_1.png',
          'name' => 'The Bright Sword',
          'author' => 'Lev Grossman',
          'price' => '65',
          'description_file' => 'description/hf_1.txt',
          'category' => 'Historical Fiction'
      ],

      [
         'image' => 'images/hf_2.png',
         'name' => 'The Lion Women of Tehran',
         'author' => 'Marjan Kamali',
         'price' => '70',
         'description_file' => 'description/hf_2.txt',
         'category' => 'Historical Fiction'
     ],
     [
         'image' => 'images/hf_3.png',
         'name' => 'The Briar Club',
         'author' => 'Kate Quinn',
         'price' => '50',
         'description_file' => 'description/hf_3.txt',
         'category' => 'Historical Fiction'
      ],
      [
         'image' => 'images/hf_4.png',
         'name' => 'Ne\'er Duke Well',
         'author' => 'Alexandra Vasti',
         'price' => '55',
         'description_file' => 'description/hf_4.txt',
         'category' => 'Historical Fiction'
      ],
      [
         'image' => 'images/hf_5.png',
         'name' => 'The Women',
         'author' => 'Kristin Hannah',
         'price' => '99',
         'description_file' => 'description/hf_5.txt',
         'category' => 'Historical Fiction'
      ],
      [
         'image' => 'images/hf_6.png',
         'name' => 'The King\'s Witches',
         'author' => 'Kristin Hannah',
         'price' => '79',
         'description_file' => 'description/hf_6.txt',
         'category' => 'Historical Fiction'
      ],
      [
         'image' => 'images/k_1.png',
         'name' => 'Harry Potter and the Philosopher\'s Stone',
         'author' => 'Rowling, J. K.',
         'price' => '45',
         'description_file' => 'description/k_1.txt',
         'category' => 'Kids'
      ],
      // Add more products here as needed
  ];
  
  foreach ($products as $product) {
      $imagePath = $product['image'];
      $bookName = $product['name'];
      $author = $product['author'];
      $price = $product['price'];
      $description = getFileContents($product['description_file']);
      $category = $product['category'];

      // Check if the product already exists
      $checkStmt = $conn->prepare("SELECT id FROM Product WHERE book_name = ? AND author = ?");
      $checkStmt->bind_param('ss', $bookName, $author);
      $checkStmt->execute();
      $checkStmt->store_result();
      
      if ($checkStmt->num_rows === 0) {
         // Prepare SQL statement for inserting new product
         $stmt = $conn->prepare("INSERT INTO Product (book_image, book_name, author, price, description, category) VALUES (?, ?, ?, ?, ?, ?)");
         $stmt->bind_param('ssssss', $imagePath, $bookName, $author, $price, $description, $category);
         
         // Execute SQL statement
         if (!($stmt->execute())) {  
             echo "Error: " . $stmt->error . "<br>";
         }
          
          $stmt->close();
      }
      
      $checkStmt->close();
  }
  
// Query to retrieve all products
$sql = "SELECT * FROM Product ORDER BY category";
$result = $conn->query($sql);

if ($result->num_rows > 0) {
   $currentCategory = "";
?> 
   <div class="container">
      <h1 class="title">OUR PRODUCTS</h1>
      <?php
      // Loop through each product and display it
         while ($row = $result->fetch_assoc()) {
            $category = htmlspecialchars($row['category']);

          // Check if the category has changed
          if ($category != $currentCategory) {
              // Close the previous category's container, if it's not the first one
              if ($currentCategory != "") {
                  echo '</div>'; // Close products-container
                  echo '</div>'; // Close same-types
              }

              // Update current category
              $currentCategory = $category;

              // Start a new category section
              echo '<div class="same-types">';
              echo '<h5>' . $currentCategory . '</h5>';
              echo '<div class="products-container">';
          }
            ?>
               <div class="product" data-name="product-<?php echo htmlspecialchars($row['id']); ?>" book-name="<?php echo htmlspecialchars($row['book_name']); ?>">
               <img src="<?php echo htmlspecialchars($row['book_image']); ?>" alt="Product Image">
               <h3><?php echo htmlspecialchars($row['book_name']); ?></h3>
               <div class="price"><?php echo 'RM'. htmlspecialchars($row['price']); ?></div>
               </div>
            <?php
            }
            ?>
         </div> <!-- Close products-container -->
      </div> <!-- Close same-types -->
   </div> <!-- Close container -->

      <div class="products-preview">
      <?php
      $result->data_seek(0); // Reset the result pointer to the beginning
      while ($row = $result->fetch_assoc()) {
      ?>
         <form method="post" action="">
         <div class="preview" data-target="product-<?php echo htmlspecialchars($row['id']); ?>">
            <img src="<?php echo htmlspecialchars($row['book_image']); ?>" alt="Product Image">
            <div class="close">X</div>
            <h3><?php echo htmlspecialchars($row['book_name']); ?></h3>
            <h6>By <?php echo htmlspecialchars($row['author']); ?></h6>
            <p><?php echo nl2br(htmlspecialchars($row['description'])); ?></p>
            <div class="price"><?php echo 'RM'. htmlspecialchars($row['price']); ?></div>
            <input type="number" min="1" value="1" name="quantity">

            <input type="hidden" name="product_id" value="<?php echo htmlspecialchars($row['id']); ?>">
            <input type="hidden" name="book_name" value="<?php echo htmlspecialchars($row['book_name']); ?>">
            <input type="hidden" name="book_image" value="<?php echo htmlspecialchars($row['book_image']); ?>">
            <input type="hidden" name="price" value="<?php echo htmlspecialchars($row['price']); ?>">
                     
            <div class="cartButton">
               <input type="submit" value="Add to cart" name="cart" class="cart">
            </div>
         </form>
         </div>';
      <?php   
      }
      ?>
      
      </div><!-- Close products-preview-->
      </div><!-- Close same-types-->
   <?php
   } else {
      echo "No products found.";
   }

   echo'</div>'; //Close container

   if (isset($_POST['cart'])) {
      $email = $_SESSION['email'];
      $cartBookName = $_POST['book_name'];
      $cartBookImage = $_POST['book_image'];
      $cartBookPrice = $_POST['price'];
      $cartQuantity = $_POST['quantity'];

      $checkStmt = $conn->prepare("SELECT quantity FROM Cart WHERE email = ? AND book_name = ?");
      $checkStmt->bind_param('ss', $email, $cartBookName);
      $checkStmt->execute();
      $result = $checkStmt->get_result();
  
      if ($result->num_rows > 0) {
          // If the product exists, update the quantity
          $row = $result->fetch_assoc();
          $newQuantity = $row['quantity'] + $cartQuantity;
  
          $updateStmt = $conn->prepare("UPDATE Cart SET quantity = ? WHERE email = ? AND book_name = ?");
          $updateStmt->bind_param('iss', $newQuantity, $email, $cartBookName);
  
          if ($updateStmt->execute()) {
              echo "Product quantity updated in the cart successfully.";
          } else {
              echo "Error updating product quantity: " . $updateStmt->error;
          }
  
          $updateStmt->close();
      } else {
          // If the product does not exist, insert a new row
          $cartStmt = $conn->prepare("INSERT INTO Cart (email, book_image, book_name, price, quantity) VALUES (?, ?, ?, ?, ?)");
          $cartStmt->bind_param('ssssi', $email, $cartBookImage, $cartBookName, $cartBookPrice, $cartQuantity);
  
          if ($cartStmt->execute()) {
              echo "Product added to cart successfully.";
          } else {
              echo "Error: " . $cartStmt->error;
          }
  
          $cartStmt->close();
      }
  
      $checkStmt->close();
   }
$conn->close();

?>


<!--
https://www.goodreads.com/  our references
-->